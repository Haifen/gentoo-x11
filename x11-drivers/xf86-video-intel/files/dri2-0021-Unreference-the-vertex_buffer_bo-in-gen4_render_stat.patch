From 5664c3a9ff2e6f4054e2cce68e810e95d324531e Mon Sep 17 00:00:00 2001
From: Carl Worth <cworth@cworth.org>
Date: Thu, 30 Oct 2008 16:53:57 -0700
Subject: [PATCH] Unreference the vertex_buffer_bo in gen4_render_state_cleanup

This avoids leaking one buffer object.
---
 src/i965_render.c |    6 +++++-
 1 files changed, 5 insertions(+), 1 deletions(-)

diff --git a/src/i965_render.c b/src/i965_render.c
index 3ebd209..b28b2ce 100644
--- a/src/i965_render.c
+++ b/src/i965_render.c
@@ -1617,12 +1617,16 @@ void
 gen4_render_state_cleanup(ScrnInfoPtr pScrn)
 {
     I830Ptr pI830 = I830PTR(pScrn);
+    struct gen4_render_state *render_state= pI830->gen4_render_state;
+
+    if (render_state->vertex_buffer_bo)
+	dri_bo_unreference (render_state->vertex_buffer_bo);
 
     if (pI830->use_drm_mode) {
 	dri_bo_unmap(pI830->gen4_render_state_mem->bo);
 	dri_bo_unreference(pI830->gen4_render_state_mem->bo);
     }
-    pI830->gen4_render_state->static_state = NULL;
+    render_state->static_state = NULL;
 }
 
 unsigned int
-- 
1.6.0.3

